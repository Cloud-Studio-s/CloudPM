# v1.0.0 – Changelog

> First public release of the fork, focused on **chunk sending** and **network/broadcast** performance.

---

## Highlights

- Added a **per-player prioritized chunk send queue** (inspired by Altay).
- Integrated this queue with PocketMine’s existing **chunk compression cache**.
- Reduced **per-packet allocations** in `NetworkSession`.
- Optimized **broadcasts to many players**, especially for entity movement and metadata.
- All changes are **internal** – no public API methods were removed or renamed.

---

## Added

### Chunk Sending

- **Per-player chunk send queue (`ChunkSendQueue`)**
  - Each player now has an internal queue of chunks to be sent.
  - Chunks are enqueued with a **priority** based on distance from the player (closer chunks first).
  - The queue:
    - Sends at most `chunksPerTick` chunks per player each tick.
    - Skips chunks that are not yet loaded.
    - Skips chunks that are no longer within the player’s view distance.
  - This reduces chunk-send spikes when:
    - Many players join at once.
    - Players teleport over long distances.
    - View distance is large.

- **`Player::sendChunkNow(int $chunkX, int $chunkZ)`**
  - New internal helper that:
    - Calls `NetworkSession::startUsingChunk()` for the specific chunk.
    - Updates internal `usedChunks` status to `REQUESTED_SENDING` → `SENT`.
    - Handles:
      - spawn chunk counting (`spawnChunkLoadCount`, `spawnThreshold`),
      - spawning entities on chunks when they are sent,
      - firing `PlayerPostChunkSendEvent`,
      - notifying the client when terrain is ready.

- **Chunk priority calculation**
  - A new helper in `Player` calculates a **priority value** (squared distance in chunks) for each chunk relative to the player.
  - Lower value = higher priority.
  - Used internally by the chunk send queue to decide which chunks go out first.

---

## Changed

### Player / Chunk Logic

- **Chunk sending flow reworked**:
  - Previously:
    - As soon as a chunk finished generating, it was sent directly in the generation callback.
  - Now:
    - When a chunk is ready, it is added to the player’s **send queue** with a computed priority.
    - Actual sending happens later via `ChunkSendQueue::process()`, honoring `chunksPerTick`.

- **`Player::doChunkRequests()`**
  - Still handles:
    - recalculating which chunks the player should use,
    - requesting those chunks from the world/generator.
  - Now also:
    - calls the chunk send queue each tick:
      - processes up to `chunksPerTick` queued chunks per player.
    - This provides a clear per-player send rate limit.

- **World change / disconnect cleanup**
  - On world change and on disconnect, the player’s chunk send queue is now **cleared**, along with `usedChunks` and `loadQueue`.
  - Prevents stale chunk send tasks from leaking across worlds or after disconnect.

---

## Network / Packet Pipeline

### NetworkSession

- **Reused packet serializer**
  - Each `NetworkSession` now holds **one reusable `ByteBufferWriter`** used for encoding outgoing packets.
  - Instead of allocating a new serializer for every send, the existing one is cleared and reused.
  - Reduces memory allocations and GC overhead in busy environments.

- **Simplified `queueCompressed()` timings**
  - Removed an extra layer of timing start/stop around `queueCompressed()`.
  - Timing is still measured where real work happens (compression, encryption, sending), avoiding redundant timing calls.

### Broadcasting (Many-Player Sends)

- **StandardPacketBroadcaster**
  - Still:
    - Encodes each packet **once**.
    - Groups sessions by compressor.
    - For large broadcasts:
      - Builds a **single compressed batch** and shares it across multiple sessions.
  - Now additionally:
    - Uses a faster **VarInt length calculation** (no `log()`, only integer comparisons).
    - Reduces repeated `spl_object_id()` calls by caching IDs per object.
    - Early-returns if:
      - there are no recipients,
      - or a `DataPacketSendEvent` handler cancels/filters out all recipients or packets.

- **NetworkBroadcastUtils**
  - `broadcastPackets()`:
    - Now:
      - returns immediately if `recipients` is empty.
      - Skips players that are not connected.
      - Groups `NetworkSession` instances directly by their `PacketBroadcaster` in a single pass.
      - Calls each broadcaster with only the sessions that use it.
    - Effect:
      - Fewer temporary arrays.
      - Less redundant work when players disconnect or when there are no actual targets.
  - `broadcastEntityEvent()`:
    - Similar improvements for entity-related broadcasts:
      - ignores disconnected players,
      - groups by `EntityEventBroadcaster`,
      - avoids unnecessary allocations when there are no recipients.

---

## Entity Broadcasting

### Movement & Metadata

- **`Entity::sendData()`**
  - Previously:
    - Always called `NetworkBroadcastUtils::broadcastEntityEvent()`, even if there were no viewers.
  - Now:
    - Returns early if the target list (or `hasSpawned`) is empty.
    - Only enters the broadcast pipeline when there is at least one viewer.
  - Effect:
    - Entities with no viewers do not trigger any broadcast logic.

- **`Entity::broadcastMovement()`**
  - Previously:
    - Always passed `hasSpawned` to `broadcastPackets()`.
  - Now:
    - If `hasSpawned` is empty (no viewers), it returns immediately.
  - Effect:
    - No movement packets are created or broadcast when nobody is watching the entity.

- **`Entity::broadcastMotion()`**
  - Same pattern as movement:
    - If `hasSpawned` is empty, no motion packets are broadcast.

### Result

- Entities that are:
  - not visible to any player, or
  - in regions with no active players,
  no longer pay the network/broadcast cost for movement and metadata updates.
- This is especially beneficial on servers with many entities but relatively few players.

---

## Behavior & Performance Notes

- **Chunk sending**
  - Now **rate-limited per player** by configuration (`CHUNK_SENDING_PER_TICK`).
  - Chunks nearer to the player are **prioritized**, improving perceived responsiveness.
  - Integrated with existing chunk compression and caching – no change required by plugin authors.

- **Networking / broadcasts**
  - Less overhead per packet and per broadcast:
    - Fewer allocations.
    - Less redundant looping.
    - Better grouping by compressors/broadcasters.

- **Entities**
  - Entity updates are **skipped entirely** when there are no viewers.
  - Reduces noise when large numbers of entities exist off-screen.

---

## Compatibility

- No public API methods were removed or renamed.
- All changes are internal to:
  - `Player`,
  - `ChunkSendQueue`,
  - `NetworkSession`,
  - `StandardPacketBroadcaster`,
  - `NetworkBroadcastUtils`,
  - and `Entity` broadcasting internals.
- Plugins written for PocketMine-MP 5 should continue to work as usual.
- Server owners should simply experience:
  - smoother chunk loading,
  - better network performance under load,
  - reduced CPU overhead for entity updates with no viewers.

---
