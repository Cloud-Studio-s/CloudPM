\# v1.0.0 – Changelog



> First public release of the fork, focused on \*\*chunk sending\*\* and \*\*network/broadcast\*\* performance.



---



\## Highlights



\- Added a \*\*per-player prioritized chunk send queue\*\*.

\- Integrated this queue with PocketMine’s existing \*\*chunk compression cache\*\*.

\- Reduced \*\*per-packet allocations\*\* in `NetworkSession`.

\- Optimized \*\*broadcasts to many players\*\*, especially for entity movement and metadata.

\- All changes are \*\*internal\*\* – no public API methods were removed or renamed.



---



\## Added



\### Chunk Sending



\- \*\*Per-player chunk send queue (`ChunkSendQueue`)\*\*

&nbsp; - Each player now has an internal queue of chunks to be sent.

&nbsp; - Chunks are enqueued with a \*\*priority\*\* based on distance from the player (closer chunks first).

&nbsp; - The queue:

&nbsp;   - Sends at most `chunksPerTick` chunks per player each tick.

&nbsp;   - Skips chunks that are not yet loaded.

&nbsp;   - Skips chunks that are no longer within the player’s view distance.

&nbsp; - This reduces chunk-send spikes when:

&nbsp;   - Many players join at once.

&nbsp;   - Players teleport over long distances.

&nbsp;   - View distance is large.



\- \*\*`Player::sendChunkNow(int $chunkX, int $chunkZ)`\*\*

&nbsp; - New internal helper that:

&nbsp;   - Calls `NetworkSession::startUsingChunk()` for the specific chunk.

&nbsp;   - Updates internal `usedChunks` status to `REQUESTED\_SENDING` → `SENT`.

&nbsp;   - Handles:

&nbsp;     - spawn chunk counting (`spawnChunkLoadCount`, `spawnThreshold`),

&nbsp;     - spawning entities on chunks when they are sent,

&nbsp;     - firing `PlayerPostChunkSendEvent`,

&nbsp;     - notifying the client when terrain is ready.



\- \*\*Chunk priority calculation\*\*

&nbsp; - A new helper in `Player` calculates a \*\*priority value\*\* (squared distance in chunks) for each chunk relative to the player.

&nbsp; - Lower value = higher priority.

&nbsp; - Used internally by the chunk send queue to decide which chunks go out first.



---



\## Changed



\### Player / Chunk Logic



\- \*\*Chunk sending flow reworked\*\*:

&nbsp; - Previously:

&nbsp;   - As soon as a chunk finished generating, it was sent directly in the generation callback.

&nbsp; - Now:

&nbsp;   - When a chunk is ready, it is added to the player’s \*\*send queue\*\* with a computed priority.

&nbsp;   - Actual sending happens later via `ChunkSendQueue::process()`, honoring `chunksPerTick`.



\- \*\*`Player::doChunkRequests()`\*\*

&nbsp; - Still handles:

&nbsp;   - recalculating which chunks the player should use,

&nbsp;   - requesting those chunks from the world/generator.

&nbsp; - Now also:

&nbsp;   - calls the chunk send queue each tick:

&nbsp;     - processes up to `chunksPerTick` queued chunks per player.

&nbsp;   - This provides a clear per-player send rate limit.



\- \*\*World change / disconnect cleanup\*\*

&nbsp; - On world change and on disconnect, the player’s chunk send queue is now \*\*cleared\*\*, along with `usedChunks` and `loadQueue`.

&nbsp; - Prevents stale chunk send tasks from leaking across worlds or after disconnect.



---



\## Network / Packet Pipeline



\### NetworkSession



\- \*\*Reused packet serializer\*\*

&nbsp; - Each `NetworkSession` now holds \*\*one reusable `ByteBufferWriter`\*\* used for encoding outgoing packets.

&nbsp; - Instead of allocating a new serializer for every send, the existing one is cleared and reused.

&nbsp; - Reduces memory allocations and GC overhead in busy environments.



\- \*\*Simplified `queueCompressed()` timings\*\*

&nbsp; - Removed an extra layer of timing start/stop around `queueCompressed()`.

&nbsp; - Timing is still measured where real work happens (compression, encryption, sending), avoiding redundant timing calls.



\### Broadcasting (Many-Player Sends)



\- \*\*StandardPacketBroadcaster\*\*

&nbsp; - Still:

&nbsp;   - Encodes each packet \*\*once\*\*.

&nbsp;   - Groups sessions by compressor.

&nbsp;   - For large broadcasts:

&nbsp;     - Builds a \*\*single compressed batch\*\* and shares it across multiple sessions.

&nbsp; - Now additionally:

&nbsp;   - Uses a faster \*\*VarInt length calculation\*\* (no `log()`, only integer comparisons).

&nbsp;   - Reduces repeated `spl\_object\_id()` calls by caching IDs per object.

&nbsp;   - Early-returns if:

&nbsp;     - there are no recipients,

&nbsp;     - or a `DataPacketSendEvent` handler cancels/filters out all recipients or packets.



\- \*\*NetworkBroadcastUtils\*\*

&nbsp; - `broadcastPackets()`:

&nbsp;   - Now:

&nbsp;     - returns immediately if `recipients` is empty.

&nbsp;     - Skips players that are not connected.

&nbsp;     - Groups `NetworkSession` instances directly by their `PacketBroadcaster` in a single pass.

&nbsp;     - Calls each broadcaster with only the sessions that use it.

&nbsp;   - Effect:

&nbsp;     - Fewer temporary arrays.

&nbsp;     - Less redundant work when players disconnect or when there are no actual targets.

&nbsp; - `broadcastEntityEvent()`:

&nbsp;   - Similar improvements for entity-related broadcasts:

&nbsp;     - ignores disconnected players,

&nbsp;     - groups by `EntityEventBroadcaster`,

&nbsp;     - avoids unnecessary allocations when there are no recipients.



---



\## Entity Broadcasting



\### Movement \& Metadata



\- \*\*`Entity::sendData()`\*\*

&nbsp; - Previously:

&nbsp;   - Always called `NetworkBroadcastUtils::broadcastEntityEvent()`, even if there were no viewers.

&nbsp; - Now:

&nbsp;   - Returns early if the target list (or `hasSpawned`) is empty.

&nbsp;   - Only enters the broadcast pipeline when there is at least one viewer.

&nbsp; - Effect:

&nbsp;   - Entities with no viewers do not trigger any broadcast logic.



\- \*\*`Entity::broadcastMovement()`\*\*

&nbsp; - Previously:

&nbsp;   - Always passed `hasSpawned` to `broadcastPackets()`.

&nbsp; - Now:

&nbsp;   - If `hasSpawned` is empty (no viewers), it returns immediately.

&nbsp; - Effect:

&nbsp;   - No movement packets are created or broadcast when nobody is watching the entity.



\- \*\*`Entity::broadcastMotion()`\*\*

&nbsp; - Same pattern as movement:

&nbsp;   - If `hasSpawned` is empty, no motion packets are broadcast.



\### Result



\- Entities that are:

&nbsp; - not visible to any player, or

&nbsp; - in regions with no active players,

&nbsp; no longer pay the network/broadcast cost for movement and metadata updates.

\- This is especially beneficial on servers with many entities but relatively few players.



---



\## Behavior \& Performance Notes



\- \*\*Chunk sending\*\*

&nbsp; - Now \*\*rate-limited per player\*\* by configuration (`CHUNK\_SENDING\_PER\_TICK`).

&nbsp; - Chunks nearer to the player are \*\*prioritized\*\*, improving perceived responsiveness.

&nbsp; - Integrated with existing chunk compression and caching – no change required by plugin authors.



\- \*\*Networking / broadcasts\*\*

&nbsp; - Less overhead per packet and per broadcast:

&nbsp;   - Fewer allocations.

&nbsp;   - Less redundant looping.

&nbsp;   - Better grouping by compressors/broadcasters.



\- \*\*Entities\*\*

&nbsp; - Entity updates are \*\*skipped entirely\*\* when there are no viewers.

&nbsp; - Reduces noise when large numbers of entities exist off-screen.



---



\## Compatibility



\- No public API methods were removed or renamed.

\- All changes are internal to:

&nbsp; - `Player`,

&nbsp; - `ChunkSendQueue`,

&nbsp; - `NetworkSession`,

&nbsp; - `StandardPacketBroadcaster`,

&nbsp; - `NetworkBroadcastUtils`,

&nbsp; - and `Entity` broadcasting internals.

\- Plugins written for PocketMine-MP 5 should continue to work as usual.

\- Server owners should simply experience:

&nbsp; - smoother chunk loading,

&nbsp; - better network performance under load,

&nbsp; - reduced CPU overhead for entity updates with no viewers.



\## Server Optimizer

For now server-optimizer will be deactivated and will be released in the future



---

